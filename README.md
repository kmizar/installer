# Общая информация

Весь проект разбит на несколько частей и ведется в нескольких репозиториях:

* Фронтенд: [https://github.com/kmizar/kmizar](https://github.com/kmizar/kmizar)
* Бекенд: [https://github.com/kmizar/backend](https://github.com/kmizar/backend)
  * _Дополнительные сервисы \(планируется\)_

Соответственно каждый репозиторий обладает своим независимым релизным циклом.  
По мимо самого проекта, для корректной работы необходимо выполнять настройки его окружения.  
Для автоматизированного процесса раскатки проекта используется отдельный скрипт: [deployPrd.sh](https://github.com/kmizar/installer/blob/master/deployPrd.sh).

# Запуск скрипта

В зависимости от типа раскатки, скрипт запускается с разным набором аттрибутов

| Опция | Описание | Тип раскатки |
| :--- | :--- | :--- |
| **-t ** | тип установки **\(prod, vm, nossl, dev\)** | prod / test / dev / nossl |
| **-s ** | название хоста \(_без www_\) | prod / test / nossl |
| **-f** | название фронтенд-репозитория | prod / test / dev / nossl |
| **-p ** | пароль к БД | prod / test / nossl |
| **-fb** | ветка фронтенд репозитория, если опция не задана - установка из master ветки | prod / test / dev / nossl |
| **-bb** | ветка бекенд репозитория, если опция не задана - установка из master ветки | prod / test / dev / nossl |
| -db |  |  |

Типы установок:

* **prod** - установка продакшен версии;
* **vm** - установка preview / test версии с ssl;
* **nossl** - установка без сертификатов;
* **dev** - локальная установка для разработки.

### Дополнительные шаги для раскатки с SSL

После завершения работы deploy-скрипта \(_если это первая выкатка с ssl или выкатка после ресетапа сервера_\) демон nginx не сможет поднятся, т.к. для https не определены ssl-сертификаты.

Описанные ниже шаги выполняются после раскатки проекта _\(завершения работы deploy скрипта\).      
_В созданной директории **./ssl\_sertificates ** в хомяке СПУЗа **hotdog **выполнить:

```
$ vim private.key #скопировать в редактор приватный ключ
$ vim chain.crt   #скопировать в редактор цепочку сертификатов
$ openssl dhparam -out ./dhparam.pem 4096 #генерим dhparam
$ systemctl start nginx
```

### Дополнительные шаги перед 1 установкой или после ресетапа

В случае, если это первая установка, или установка после полного ресетапа сервера необходимо сделать следующее:

```
$ yum install git #ставим гит на сервер
$ ssh-keygen #генерим ssh ключ
$ cat ~/.ssh/id_rsa.pub #копируем ключ

#Добавляем ключ в настройках github
```

# Описание deploy-скрипта

Скрипт выполняет раскатку проекта на _**dev/preview/prod**_ стенды. Для установки на preview/prod выполняется конфигурация окружения. Серверная установка выполняется только на тачке с **CentOS**.

При локальной установке подразумевается уже настроенное окружение, т.е. срипт только раскатывает код проекта.

### Полный перечень действий deploy-скрипта

* Создание в ОС пользователя hotdog
* Установка epel-release + update
* Установка python 3.5
* Установка postgreSQL
* Установка nginx
* Установка gcc библиотеки
* Создание python виртуалки

  * Установка django 1.9
  * Установка доп библиотек

    * psycopg2

    * django-ckeditor

    * django-resized

    * pillow

    * unicorns

  * Создание django app

  * Конфигурация app

* Клонирование репозитория фронтенда

* Клонирование репозитория бекенда

* Создание БД \(таблицы, пользователь, раздача грантов\)

* Конфигурация gunicorns

* Конфигурация nginx

* Общая конфигурация приложения в зависимости от установки

* Миграция статики

* Настройка метрик

* Настройка robots.txt

* Запуск демонов

* Открытие портов



